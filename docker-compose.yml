# version: '3.8' # Obsoleto en Docker Compose v2+

services:
  db:
    image: mysql:8.0
    container_name: cfp_db_prod
    restart: always
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-CFP}
      MYSQL_USER: ${MYSQL_USER:-cfp_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "127.0.0.1:3308:3306" # Solo accesible desde localhost
    networks:
      - cfp_network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cfp_backend_prod
    restart: always
    command: /entrypoint.sh
    # volumes:
    #   - ./backend:/app # Solo para desarrollo local, no en producci√≥n
    environment:
      - DB_ENGINE=django.db.backends.mysql
      - DB_NAME=${MYSQL_DATABASE:-CFP}
      - DB_USER=${MYSQL_USER:-cfp_user}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_HOST=db
      - DB_PORT=3306
      - DJANGO_ALLOWED_HOSTS=cfp.lucasoviedodev.org,localhost,127.0.0.1
      - DJANGO_DEBUG=${DJANGO_DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ALLOWED_ORIGINS=http://localhost:8085,http://192.168.1.212,http://192.168.1.212:8085,http://ips6-server.com,https://cfp.lucasoviedodev.org,https://www.lucasoviedodev.org,https://lucasoviedodev.org
      # Email configuration
      - EMAIL_BACKEND=${EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
      - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS:-True}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      - DEFAULT_FROM_EMAIL=${DEFAULT_FROM_EMAIL:-CFP <soporte@lucasoviedodev.org>}
      - FRONTEND_URL=${FRONTEND_URL:-https://cfp.lucasoviedodev.org}
    depends_on:
      - db
    networks:
      - cfp_network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cfp_frontend_prod
    restart: always
    ports:
      - "8085:80" # Frontend accesible en puerto 8085
      - "8444:443" # Frontend HTTPS accesible en puerto 8444
    depends_on:
      - backend
    volumes:
      - /home/admin486321/ssl:/etc/nginx/ssl:ro
    networks:
      - cfp_network

volumes:
  db_data:


networks:
  cfp_network:
    driver: bridge
